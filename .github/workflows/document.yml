name: 2. ðŸ›¡ï¸Update Documentation

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

env:
  # å®šä¹‰é¢œè‰²å’Œå›¾æ ‡ï¼Œè®©æ—¥å¿—åƒä»ªè¡¨ç›˜ä¸€æ ·æ¼‚äº®
  COLOR_RESET: '\033[0m'
  COLOR_CYAN: '\033[36m'
  COLOR_GREEN: '\033[32m'
  COLOR_RED: '\033[31m'
  COLOR_YELLOW: '\033[33m'
  ICON_START: 'ðŸš€'
  ICON_OK: 'âœ…'
  ICON_FAIL: 'âŒ'
  ICON_INFO: 'â„¹ï¸'

jobs:
  gen_docs:
    name: ðŸ—ï¸ Build & Publish
    runs-on: ubuntu-latest
    
    # å¿…é¡»æœ‰å†™å…¥æƒé™æ‰èƒ½æäº¤ README
    permissions:
      contents: write

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ðŸ“¥ Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # è½»é‡çº§æ‹‰å–

      # 2. çŽ¯å¢ƒå‡†å¤‡
      - name: ðŸ Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ðŸ“ Generate README
        id: generate
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          # å¼€å¯æ—¥å¿—åˆ†ç»„ï¼ŒæŠ˜å æ‚ä¹±ä¿¡æ¯
          echo "::group::ðŸ” System Check & Init"
          echo -e "${COLOR_CYAN}${ICON_INFO} System: Ubuntu Latest"
          echo -e "${COLOR_CYAN}${ICON_INFO} Python: $(python --version)"
          echo "::endgroup::"
          
          echo "::group::ðŸš€ Execute Generator Script"
          echo -e "${COLOR_CYAN}Running src/docs_gen.py...${COLOR_RESET}"
          
          # è®°å½•å¼€å§‹æ—¶é—´
          START_TIME=$(date +%s)
          
          # âš ï¸ æ ¸å¿ƒæ‰§è¡Œå‘½ä»¤
          # å¦‚æžœè¿™é‡ŒæŠ¥é”™ï¼ˆæ¯”å¦‚ç¼ºå°‘æ–‡ä»¶ï¼Œä»£ç æœ‰Bugï¼‰ï¼Œè„šæœ¬ä¼šç«‹å³åœæ­¢ (set -e æ˜¯é»˜è®¤å¼€å¯çš„)
          if [ -f "src/docs_gen.py" ]; then
             python src/docs_gen.py
          elif [ -f "docs_gen.py" ]; then
             python docs_gen.py
          else
             echo -e "${COLOR_RED}${ICON_FAIL} Error: Script 'docs_gen.py' not found!${COLOR_RESET}"
             exit 1
          fi
          
          # è®¡ç®—è€—æ—¶
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "DURATION=$DURATION" >> $GITHUB_OUTPUT
          
          echo -e "${COLOR_GREEN}${ICON_OK} Generation Completed in ${DURATION}s.${COLOR_RESET}"
          echo "::endgroup::"

      # 4. æäº¤ä»£ç  (ä»…åœ¨æœ‰å˜åŒ–æ—¶)
      - name: ðŸ’¾ Commit Changes
        id: auto_commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Docs: Auto update README rule list ðŸ“ [skip ci]"
          file_pattern: "README.md"
          skip_dirty_check: false
          create_branch: false

      - name: ðŸ“Š Job Summary
        if: always() 
        run: |
          # å‡†å¤‡çŠ¶æ€é¢œè‰²
          if [ "${{ job.status }}" == "success" ]; then
            STATUS_BADGE="âœ… **Success**"
            COLOR="green"
          else
            STATUS_BADGE="âŒ **Failed**"
            COLOR="red"
          fi
          
          # å†™å…¥ GitHub Summary
          echo "## ðŸ›¡ï¸ Documentation Update Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Status / Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Result** | <span style='color:$COLOR'>$STATUS_BADGE</span> |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow File** | \`document.yml\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Time Taken** | ${{ steps.generate.outputs.DURATION }}s |" >> $GITHUB_STEP_SUMMARY
          echo "| **Executed At** | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.auto_commit.outputs.changes_detected }}" == "true" ]; then
             echo "| **Changes** | ðŸ“ README.md Updated |" >> $GITHUB_STEP_SUMMARY
          else
             echo "| **Changes** | ðŸ’¤ No formatting changes |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> _Generated by [Action Runner](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})_" >> $GITHUB_STEP_SUMMARY

  log-failure:
    needs: gen_docs
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸš¨ Error Notification
        run: echo "::error::Workflow failed in document.yml! Please examine the logs."
