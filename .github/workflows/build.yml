name: Rule Set Build Logic

on:
  workflow_dispatch:        # 允许手动触发
  push:
    paths:
      - 'repos.json'        # 当配置文件修改时触发
      - 'src/**'            # 当脚本修改时触发
  schedule:
    - cron: '0 20 * * *'    # 每天北京时间早4点运行 (UTC 20:00)

jobs:
  build_rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write       # 必须有写权限才能提交

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Sing-box (Latest)
        run: |
          LATEST_API=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest)
          # 使用 jq 提取 tag_name，兼容性更好
          TAG=$(echo "$LATEST_API" | jq -r .tag_name)
          VER=${TAG#v}
          
          # 构造下载链接
          URL="https://github.com/SagerNet/sing-box/releases/download/${TAG}/sing-box-${VER}-linux-amd64.tar.gz"
          echo "⬇️ Downloading sing-box $TAG from $URL"
          
          wget -qO sb.tar.gz "$URL"
          tar -zxf sb.tar.gz
          
          # 移动并赋予执行权限
          sudo mv sing-box-*/sing-box /usr/local/bin/
          sudo chmod +x /usr/local/bin/sing-box
          
          # 检查版本
          sing-box version

      - name: Run Optimization Script
        run: |
          # 确保脚本有执行权限 (虽然是 python -u 运行，这也是好习惯)
          # 如果你的 main.py 在 src 目录下
          python -u src/main.py

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto: Update rules [skip ci]"
          file_pattern: "rules-txt rules-json rules-srs"
          push_options: '--force' # 可选，强制推送防止冲突，视需求开启
